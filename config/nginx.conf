server {
    listen 4097;

    # Global proxy settings
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_read_timeout 86400;
    proxy_buffering on;
    proxy_buffer_size 128k;
    proxy_buffers 4 256k;
    proxy_busy_buffers_size 256k;

    # Strip ALL problematic upstream headers (CF-RAY causes null byte issues)
    proxy_hide_header Content-Security-Policy;
    proxy_hide_header X-Content-Security-Policy;
    proxy_hide_header CF-RAY;
    proxy_hide_header CF-Cache-Status;
    proxy_hide_header CF-Request-ID;
    proxy_hide_header Report-To;
    proxy_hide_header NEL;

    types {
        application/javascript js mjs;
        text/css css;
        text/html html htm;
        application/json json;
        image/svg+xml svg;
        image/png png;
        image/x-icon ico;
        application/manifest+json webmanifest;
    }
    default_type application/octet-stream;

    location / {
        proxy_pass http://127.0.0.1:4096;
        add_header Content-Security-Policy "default-src * data: blob: ws: wss: 'unsafe-inline' 'unsafe-eval'; script-src * data: blob: 'unsafe-inline' 'unsafe-eval'; style-src * data: blob: 'unsafe-inline' 'unsafe-eval';" always;
    }

    location ~* \.js$ {
        proxy_pass http://127.0.0.1:4096;
        add_header Content-Type "application/javascript" always;
        add_header Content-Security-Policy "default-src * data: blob: ws: wss: 'unsafe-inline' 'unsafe-eval'; script-src * data: blob: 'unsafe-inline' 'unsafe-eval'; style-src * data: blob: 'unsafe-inline' 'unsafe-eval';" always;
    }

    location ~* \.css$ {
        proxy_pass http://127.0.0.1:4096;
        add_header Content-Type "text/css" always;
        add_header Content-Security-Policy "default-src * data: blob: ws: wss: 'unsafe-inline' 'unsafe-eval'; script-src * data: blob: 'unsafe-inline' 'unsafe-eval'; style-src * data: blob: 'unsafe-inline' 'unsafe-eval';" always;
    }
}
